<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.adpanshi.cashloan.manage.cl.mapper.BorrowRepayMapper">
  <resultMap id="BaseResultMap" type="com.adpanshi.cashloan.manage.cl.model.BorrowRepay">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="user_id" jdbcType="BIGINT" property="userId" />
    <result column="borrow_id" jdbcType="BIGINT" property="borrowId" />
    <result column="amount" jdbcType="DECIMAL" property="amount" />
    <result column="repay_time" jdbcType="TIMESTAMP" property="repayTime" />
    <result column="state" jdbcType="VARCHAR" property="state" />
    <result column="penalty_amout" jdbcType="DECIMAL" property="penaltyAmout" />
    <result column="penalty_day" jdbcType="INTEGER" property="penaltyDay" />
  </resultMap>
  <resultMap id="userBorrowRayMap"  extends="BaseResultMap" type="com.adpanshi.cashloan.manage.cl.model.expand.BorrowRepayModel">
    <result column="real_name" property="realName" jdbcType="VARCHAR" />
    <result column="phone" property="phone" jdbcType="VARCHAR" />
    <result column="order_no" property="orderNo" jdbcType="VARCHAR" />
    <result column="borrow_amount" property="borrowAmount" jdbcType="DECIMAL" />
    <result column="repay_amount" property="repayAmount" jdbcType="DECIMAL" />
    <result column="borrow_time" property="borrowTime" jdbcType="TIMESTAMP" />
    <result column="id_no" property="idNo" jdbcType="VARCHAR" />
    <result column="audit_time" property="auditTime" jdbcType="TIMESTAMP" />
    <result column="real_amout" property="realAmout" jdbcType="DECIMAL" />
    <result column="real_penalty_amout" property="realPenaltyAmout" jdbcType="DECIMAL" />
    <result column="borrow_state" property="borrowState" jdbcType="VARCHAR" />
    <result column="repay_way" property="repayWay" jdbcType="VARCHAR" />
    <result column="repay_account" property="repayAccount" jdbcType="VARCHAR" />
    <result column="serial_number" property="serialNumber" jdbcType="VARCHAR" />
    <result column="phase" property="phase" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Example_Where_Clause">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <where>
      <foreach collection="example.oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, user_id, borrow_id, amount, repay_time, state, penalty_amout, penalty_day
  </sql>
  <select id="selectByExample" parameterType="com.adpanshi.cashloan.manage.cl.model.BorrowRepayExample" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    from `cl_borrow_repay`
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from `cl_borrow_repay`
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from `cl_borrow_repay`
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <delete id="deleteByExample" parameterType="com.adpanshi.cashloan.manage.cl.model.BorrowRepayExample">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from `cl_borrow_repay`
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.adpanshi.cashloan.manage.cl.model.BorrowRepay">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into `cl_borrow_repay` (id, user_id, borrow_id, 
      amount, repay_time, state, 
      penalty_amout, penalty_day)
    values (#{id,jdbcType=BIGINT}, #{userId,jdbcType=BIGINT}, #{borrowId,jdbcType=BIGINT}, 
      #{amount,jdbcType=DECIMAL}, #{repayTime,jdbcType=TIMESTAMP}, #{state,jdbcType=VARCHAR}, 
      #{penaltyAmout,jdbcType=DECIMAL}, #{penaltyDay,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" parameterType="com.adpanshi.cashloan.manage.cl.model.BorrowRepay">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into `cl_borrow_repay`
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="userId != null">
        user_id,
      </if>
      <if test="borrowId != null">
        borrow_id,
      </if>
      <if test="amount != null">
        amount,
      </if>
      <if test="repayTime != null">
        repay_time,
      </if>
      <if test="state != null">
        state,
      </if>
      <if test="penaltyAmout != null">
        penalty_amout,
      </if>
      <if test="penaltyDay != null">
        penalty_day,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="userId != null">
        #{userId,jdbcType=BIGINT},
      </if>
      <if test="borrowId != null">
        #{borrowId,jdbcType=BIGINT},
      </if>
      <if test="amount != null">
        #{amount,jdbcType=DECIMAL},
      </if>
      <if test="repayTime != null">
        #{repayTime,jdbcType=TIMESTAMP},
      </if>
      <if test="state != null">
        #{state,jdbcType=VARCHAR},
      </if>
      <if test="penaltyAmout != null">
        #{penaltyAmout,jdbcType=DECIMAL},
      </if>
      <if test="penaltyDay != null">
        #{penaltyDay,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <insert id="saveAll" parameterType="com.adpanshi.cashloan.manage.cl.model.BorrowRepay">
    insert into cl_borrow_repay(user_id,borrow_id,amount,repay_time,state,penalty_amout,penalty_day) VALUES
    <foreach collection="list" item="item" separator=",">
      (#{item.userId,jdbcType=BIGINT},
      #{item.borrowId,jdbcType=BIGINT},
      #{item.amount,jdbcType=DECIMAL},
      #{item.repayTime,jdbcType=TIMESTAMP},
      #{item.state,jdbcType=VARCHAR},
      #{item.penaltyAmout,jdbcType=DECIMAL},
      #{item.penaltyDay,jdbcType=VARCHAR})
    </foreach>
  </insert>
    <select id="countByExample" parameterType="com.adpanshi.cashloan.manage.cl.model.BorrowRepayExample" resultType="java.lang.Long">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select count(*) from `cl_borrow_repay`
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <sql id="searchBy">
    <trim prefix="where" prefixOverrides="and|or">
      <if test="id !='' and id !=null">
        id  = #{id,jdbcType=BIGINT}
      </if>
      <if test="userId !='' and userId !=null">
        and user_id = #{userId,jdbcType=BIGINT}
      </if>
      <if test="borrowId !='' and borrowId !=null">
        and borrow_id = #{borrowId,jdbcType=BIGINT}
      </if>
      <if test="amount !='' and amount !=null">
        and amount = #{amount,jdbcType=DECIMAL}
      </if>
      <if test="repayTime !=null">
        and repay_time = #{repayTime,jdbcType=TIMESTAMP}
      </if>
      <if test="state !='' and state !=null">
        and state = #{state,jdbcType=VARCHAR}
      </if>
      <if test="penaltyAmout !='' and penaltyAmout !=null">
        and penalty_amout = #{penaltyAmout,jdbcType=DECIMAL}
      </if>
      <if test="penaltyDay !='' and penaltyDay !=null">
        and penalty_day = #{penaltyDay,jdbcType=VARCHAR}
      </if>
    </trim>
  </sql>
  <select id="listSelective" resultMap="BaseResultMap" parameterType="java.util.HashMap">
    select
    <include refid="Base_Column_List" />
    from cl_borrow_repay
    <include refid="searchBy"/>
  </select>
  <select id="listOverDueUser" resultType="com.adpanshi.cashloan.manage.cl.pojo.OverDueUser">
    SELECT
    a.user_id AS userId,
    a.borrow_id as borrowId,
    a.amount as amount,
    a.repay_time as repayTime,
    a.penalty_amout as penaltyAmout,
    a.penalty_day as penaltyDay,
    b.real_name as realName,
    b.phone as phone,
    b.sex as sex
    FROM cl_borrow_repay a, cl_user_base_info b
    WHERE a.penalty_day > 0 AND a.state = 20 AND a.user_id = b.user_id;
  </select>
  <update id="updateByExampleSelective" parameterType="map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update `cl_borrow_repay`
    <set>
      <if test="record.id != null">
        id = #{record.id,jdbcType=BIGINT},
      </if>
      <if test="record.userId != null">
        user_id = #{record.userId,jdbcType=BIGINT},
      </if>
      <if test="record.borrowId != null">
        borrow_id = #{record.borrowId,jdbcType=BIGINT},
      </if>
      <if test="record.amount != null">
        amount = #{record.amount,jdbcType=DECIMAL},
      </if>
      <if test="record.repayTime != null">
        repay_time = #{record.repayTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.state != null">
        state = #{record.state,jdbcType=VARCHAR},
      </if>
      <if test="record.penaltyAmout != null">
        penalty_amout = #{record.penaltyAmout,jdbcType=DECIMAL},
      </if>
      <if test="record.penaltyDay != null">
        penalty_day = #{record.penaltyDay,jdbcType=INTEGER},
      </if>
    </set>
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>

  <update id="updateByPrimaryKeySelective" parameterType="com.adpanshi.cashloan.manage.cl.model.BorrowRepay">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update `cl_borrow_repay`
    <set>
      <if test="userId != null">
        user_id = #{userId,jdbcType=BIGINT},
      </if>
      <if test="borrowId != null">
        borrow_id = #{borrowId,jdbcType=BIGINT},
      </if>
      <if test="amount != null">
        amount = #{amount,jdbcType=DECIMAL},
      </if>
      <if test="repayTime != null">
        repay_time = #{repayTime,jdbcType=TIMESTAMP},
      </if>
      <if test="state != null">
        state = #{state,jdbcType=VARCHAR},
      </if>
      <if test="penaltyAmout != null">
        penalty_amout = #{penaltyAmout,jdbcType=DECIMAL},
      </if>
      <if test="penaltyDay != null">
        penalty_day = #{penaltyDay,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateParam"  parameterType="java.util.HashMap">
    update cl_borrow_repay
    <set>
      state = #{state,jdbcType=VARCHAR} ,
      <if test="penaltyDay !=null and penaltyDay != ''">
        penalty_day = #{penaltyDay,jdbcType=VARCHAR},
      </if>
      <if test="penaltyAmout !=null">
        penalty_amout = #{penaltyAmout,jdbcType=DECIMAL} ,
      </if>
      <if test="repayTime != null ">
        repay_time = #{repayTime,jdbcType=TIMESTAMP}
      </if>
    </set>
    where state = '20' and id = #{id ,jdbcType=BIGINT}
  </update>
  <update id="updateByExample" parameterType="map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update `cl_borrow_repay`
    set user_id = #{userId,jdbcType=BIGINT},
      borrow_id = #{borrowId,jdbcType=BIGINT},
      amount = #{amount,jdbcType=DECIMAL},
      repay_time = #{repayTime,jdbcType=TIMESTAMP},
      state = #{state,jdbcType=VARCHAR},
      penalty_amout = #{penaltyAmout,jdbcType=DECIMAL},
      penalty_day = #{penaltyDay,jdbcType=INTEGER}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <resultMap extends="BaseResultMap" id="userBorrowMap" type="com.adpanshi.cashloan.manage.cl.model.expand.BorrowModel">
    <result column="real_name" jdbcType="VARCHAR" property="realName" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="repay_amount" jdbcType="DECIMAL" property="repayAmount" />
    <result column="repay_time" jdbcType="VARCHAR" property="repayTime" />
    <result column="penalty_amout" jdbcType="DECIMAL" property="penaltyAmout" />
    <result column="penalty_day" jdbcType="VARCHAR" property="penaltyDay" />
    <result column="time_limit" jdbcType="VARCHAR" property="timeLimit" />
    <result column="phase" jdbcType="INTEGER" property="phase" />
  </resultMap>
  <resultMap extends="BaseResultMap" id="BorrowRepayModel" type="com.adpanshi.cashloan.manage.cl.model.expand.BorrowRepayModel">
    <result column="real_name" jdbcType="VARCHAR" property="realName" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="order_no" jdbcType="VARCHAR" property="orderNo" />
    <result column="borrow_amount" jdbcType="DECIMAL" property="borrowAmount" />
    <result column="repay_amount" jdbcType="DECIMAL" property="repayAmount" />
    <result column="repay_total" jdbcType="DECIMAL" property="repayTotal" />
    <result column="repay_plan_time" jdbcType="TIMESTAMP" property="repayPlanTime" />
    <result column="repayTimeStr" jdbcType="TIMESTAMP" property="repayTimeStr" />
    <result column="id_no" jdbcType="VARCHAR" property="idNo" />
    <result column="confirm_time" jdbcType="TIMESTAMP" property="confirmTime" />
    <result column="confirm_name" jdbcType="VARCHAR" property="confirmName" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
  </resultMap>
  <!-- 还款计划查询-->
  <select id="listModelNew" parameterType="java.util.Map" resultMap="BorrowRepayModel">
    select br.id,cu.real_name,cu.phone,cu.id_no,cb.order_no,cb.amount borrow_amount,br.penalty_amout,br.penalty_day,cb.create_time,
    br.amount repay_amount,br.penalty_amout+br.amount repay_total,br.repay_time repay_plan_time,brl.repay_time repayTime,brl.confirm_time,
    su.name confirm_name,br.state
    from cl_borrow_repay br
    left join cl_borrow_repay_log brl on br.id = brl.repay_id
    left join  cl_user_base_info cu on br.user_id = cu.user_id
    left join arc_sys_user su on brl.confirm_id = su.id
    left join cl_borrow cb on cb.id = br.borrow_id

    <trim prefix="where" prefixOverrides="and|or">
      <if test="realName !='' and realName !=null">
        cu.real_name   like  concat("%",#{realName,jdbcType=VARCHAR},"%")
      </if>
      <if test="phone !='' and phone !=null">
        and cu.phone  like  concat("%",#{phone,jdbcType=VARCHAR},"%")
      </if>
      <if test="orderNo !='' and orderNo !=null">
        and cb.order_no like  concat("%",#{orderNo,jdbcType=VARCHAR},"%")
      </if>
      <if test="state != null and state != '' ">
        and br.state = #{state,jdbcType=VARCHAR}
      </if>
      <if test="startTime != null">
        and DATE_FORMAT(br.repay_time,'%Y-%m-%d')  &gt;= #{startTime,jdbcType=TIMESTAMP}
      </if>
      <if test="endTime  != null">
        and DATE_FORMAT(br.repay_time,'%Y-%m-%d')  &lt;= #{endTime,jdbcType=TIMESTAMP}
      </if>
      <if test="startPenaltyDay != null and startPenaltyDay !=''">
        and br.penalty_day &gt;= #{startPenaltyDay}
      </if>
      <if test="endPenaltyDay != null and endPenaltyDay !=''">
        and br.penalty_day &lt;= #{endPenaltyDay}
      </if>
      <if test="idNo != null and idNo !=''">
        and cu.id_no  like  concat("%",#{idNo,jdbcType=VARCHAR},"%")
      </if>
      <!--end-->
    </trim>
  </select>
  <sql id="searchUrgeBy">
    <trim prefix="where" prefixOverrides="and|or">
      <if test="state !='' and state !=null">
        and b.state = #{state,jdbcType=VARCHAR}
      </if>
      <if test="realName !='' and realName !=null">
        and u.real_name like  concat("%",#{realName,jdbcType=VARCHAR},"%")
      </if>
      <if test="phone !='' and phone !=null">
        and u.phone like  concat("%",#{phone,jdbcType=VARCHAR},"%")
      </if>
      <if test="orderNo !='' and orderNo !=null">
        and b.order_no like  concat("%",#{orderNo,jdbcType=VARCHAR},"%")
      </if>
      and b.id not in (select borrow_id from cl_urge_repay_order)
    </trim>
  </sql>
  <select id="listModelNotUrge" parameterType="java.util.HashMap" resultMap="userBorrowMap">
    select  u.real_name,u.phone,
    b.id,b.order_no,b.amount ,b.fee,b.time_limit,b.state,b.service_fee,b.info_auth_fee,b.interest,b.create_time,
    r.amount  as repay_amount,r.repay_time,r.penalty_amout,r.penalty_day,r.borrow_id,
    CASE INSTR(b.order_no,'X') WHEN 0 THEN 1 ELSE 0+SUBSTR(b.order_no,INSTR(b.order_no,'X')+1) END as phase/*期数new*/
    from  cl_borrow b  left join  cl_user_base_info u on  u.user_id=b.user_id  join cl_borrow_repay r on r.borrow_id=b.id
    <include refid="searchUrgeBy" />
    ORDER BY b.create_time DESC
  </select>
  <sql id="searchModelBy">
    <trim prefix="where" prefixOverrides="and|or">
      <if test="realName !='' and realName !=null">
        u.real_name   like  concat("%",#{realName,jdbcType=VARCHAR},"%")
      </if>
      <if test="phone !='' and phone !=null">
        and u.phone  like  concat("%",#{phone,jdbcType=VARCHAR},"%")
      </if>
      <if test="orderNo !='' and orderNo !=null">
        and b.order_no like  concat("%",#{orderNo,jdbcType=VARCHAR},"%")
      </if>
      <if test="serialNumber !='' and serialNumber !=null">
        and INSTR(l.serial_number,#{serialNumber,jdbcType=VARCHAR})
      </if>
      <if test="repayAccount !='' and repayAccount !=null">
        and INSTR(l.repay_account,#{repayAccount,jdbcType=VARCHAR})
      </if>
      <if test="borrowMainId != null and borrowMainId != '' ">
        and b.borrow_main_id = #{borrowMainId,jdbcType=INTEGER}
      </if>
      <if test="state != null and state != '' ">
        and b.state = #{state,jdbcType=VARCHAR}
      </if>
      <if test="repayState != null and repayState != '' ">
        and r.state = #{repayState,jdbcType=VARCHAR}
      </if>
      <if test="repayWay != null and repayWay != '' ">
        and l.repay_way = #{repayWay,jdbcType=VARCHAR}
      </if>
      <if test="auditName != null and auditName != '' ">
        and b.audit_name like  concat("%",#{auditName,jdbcType=VARCHAR},"%")
      </if>
      <if test="startTime != null">
        and DATE_FORMAT(r.repay_time,'%Y-%m-%d')  &gt;= #{startTime,jdbcType=TIMESTAMP}
      </if>
      <if test="endTime  != null">
        and DATE_FORMAT(r.repay_time,'%Y-%m-%d')  &lt;= #{endTime,jdbcType=TIMESTAMP}
      </if>
      <if test="realityStartTime   != null">
        and DATE_FORMAT(l.repay_time,'%Y-%m-%d')  &gt;= #{realityStartTime,jdbcType=TIMESTAMP}
      </if>
      <if test="realityEndTime    != null">
        and DATE_FORMAT(l.repay_time,'%Y-%m-%d')  &lt;= #{realityEndTime,jdbcType=TIMESTAMP}
      </if>
      <if test="startAuditTime   != null">
        and b.audit_time &gt;= #{startAuditTime,jdbcType=TIMESTAMP}
      </if>
      <if test="endAuditTime    != null">
        and b.audit_time  &lt;= #{endAuditTime,jdbcType=TIMESTAMP}
      </if>
      <if test="timeLimit != null and timeLimit !=''">
        and b.time_limit = #{timeLimit}
      </if>
      <!--end-->
    </trim>
  </sql>
  <select id="listModel" resultMap="userBorrowRayMap" parameterType="java.util.HashMap">
    select * from (
    select
    r.id,r.user_id,r.borrow_id/*old*/,u.real_name/*真实姓名old*/,u.phone/*手机号old*/,u.id_no/*，身份证号old*/,b.order_no/*订单号old*/,b.create_time
    as borrow_time/*订单生成时间old*/,r.penalty_day/*逾期天数old*/,
    r.state/*还款状态 old*/,r.amount as repay_amount/*应还款金额(元)old*/,r.penalty_amout /*应还逾期罚金(元)old*/,
    l.amount as real_amout/*已还款金额(元)new*/,l.penalty_amout as real_penalty_amout /*已还逾期罚金(元)new*/,r.repay_time as
    repay_plan_time/*应还款日期old*/,b.audit_name/*审核人old*/,b.audit_time/*old*/,
    l.repay_time/*实际还款日期old*/,b.state as borrow_state/*订单状态new*/,l.repay_way/*还款方式new*/,l.repay_account/*还款账号new*/,l.serial_number/*流水号new*/,
    CASE INSTR(b.order_no,'X') WHEN 0 THEN 1 ELSE 0+SUBSTR(b.order_no,INSTR(b.order_no,'X')+1) END as phase/*期数new*/
    FROM cl_borrow_repay r
    LEFT JOIN cl_user_base_info u ON r.user_id = u.user_id
    LEFT JOIN cl_borrow b ON r.borrow_id = b.id
    LEFT JOIN cl_borrow_repay_log l ON l.repay_id = r.id
    <include refid="searchModelBy"/>
    ORDER BY r.id DESC
    <if test="totalCount !='' and totalCount !=null">
      limit #{totalCount,jdbcType = BIGINT}
    </if>
    )borrow_repay_info
    <if test="phase !='' and phase !=null">
      where phase = #{phase,jdbcType = BIGINT}
    </if>
  </select>
  <select id="findOverdue" resultMap="BorrowRepayModel" parameterType="java.lang.Long">
    SELECT cb.create_time,cbr.amount,cbr.repay_time,cbr.penalty_day,cbr.penalty_amout,cb.order_no,
    (SELECT login_name FROM cl_user WHERE id = cb.user_id) AS phone,
    (SELECT real_name FROM cl_user_base_info WHERE user_id = cb.user_id) AS realName
    FROM cl_borrow_repay AS cbr LEFT JOIN cl_borrow AS cb ON cbr.borrow_id = cb.id
    WHERE cb.id = #{id,jdbcType=BIGINT}
  </select>
</mapper>